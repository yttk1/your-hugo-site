{{ define "main" }}
<h1 style="text-align:center; color:#fff;">ðŸ›’ Your Cart</h1>

<div id="cart-container">
  <div id="cart-items"></div>
  <div id="cart-summary">
    <p>Total: <span id="cart-total">$0.00</span></p>
    <div class="cart-buttons">
        <button id="empty-cart-btn">ðŸ—‘ Empty Cart</button>
        <button id="checkout-btn">Proceed to Checkout</button>
    </div>
  </div>
</div>

<style>
#cart-container {
  background: #1e293b;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  color: white;
  max-width: 800px;
  margin: 2rem auto;
}
.cart-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #334155;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1rem;
}
.cart-item img {
  width: 80px;
  height: 80px;
  border-radius: 8px;
  object-fit: cover;
}
.cart-info {
  flex: 1;
  margin-left: 1rem;
}
.cart-info h3 {
  margin: 0;
  font-size: 1.1rem;
}
.cart-info p {
  margin: 0.3rem 0;
  color: #94a3b8;
}
.cart-actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.cart-actions button {
  background: #2563eb;
  color: white;
  border: none;
  padding: 0.4rem 0.8rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
.cart-actions button:hover {
  background: #1d4ed8;
}
#cart-summary {
  text-align: right;
  margin-top: 1.5rem;
  font-size: 1.2rem;
}
#checkout-btn {
  margin-top: 1rem;
  background: #22c55e;
  color: white;
  border: none;
  padding: 0.8rem 1.4rem;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  
}
#checkout-btn:hover {
  background: #16a34a;
}
.empty-cart {
  text-align: center;
  color: #94a3b8;
  font-size: 1.1rem;
}

.cart-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  margin-top: 1rem;
}

#empty-cart-btn {
  margin-top: 1rem;
  background: #dc2626;
  color: white;
  border: none;
  padding: 0.8rem 1.4rem;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
}

#empty-cart-btn:hover {
  background: #b91c1c;
}

</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const user = localStorage.getItem("user");
  const key = user ? `cart_${user}` : "cart";
  let cart = JSON.parse(localStorage.getItem(key)) || [];

  const itemsContainer = document.getElementById("cart-items");
  const totalEl = document.getElementById("cart-total");

  function renderCart() {
    itemsContainer.innerHTML = "";
    let total = 0;

    // Clean out zero-quantity items
    cart = cart.filter(i => i.qty > 0);

    if (cart.length === 0) {
      itemsContainer.innerHTML = `<p class="empty-cart">Your cart is empty.</p>`;
      totalEl.textContent = "$0.00";
      localStorage.setItem(key, JSON.stringify(cart));
      window.dispatchEvent(new Event("storage"));
      return;
    }

    cart.forEach((item, index) => {
      total += item.price * item.qty;

      const itemEl = document.createElement("div");
      itemEl.classList.add("cart-item");
      itemEl.innerHTML = `
        <img src="${item.img}" alt="${item.title}">
        <div class="cart-info">
          <h3>${item.title}</h3>
          <p>$${item.price.toFixed(2)} Ã— ${item.qty}</p>
        </div>
        <div class="cart-actions">
          <button class="dec" data-index="${index}">âˆ’</button>
          <button class="inc" data-index="${index}">+</button>
          <button class="del" data-index="${index}">ðŸ—‘</button>
        </div>
      `;
      itemsContainer.appendChild(itemEl);
    });

    totalEl.textContent = `$${total.toFixed(2)}`;
    localStorage.setItem(key, JSON.stringify(cart));
    window.dispatchEvent(new Event("storage"));
  }

  // Handle button actions
  itemsContainer.addEventListener("click", (e) => {
    if (e.target.tagName !== "BUTTON") return;
    const index = e.target.dataset.index;
    const action = e.target.className;

    if (action === "inc") {
      cart[index].qty += 1;
    } else if (action === "dec") {
      cart[index].qty -= 1;
    } else if (action === "del") {
      cart.splice(index, 1);
    }

    renderCart(); // Always re-render and clean up
  });

  document.getElementById("checkout-btn").addEventListener("click", () => {
    const user = localStorage.getItem("user");
    const key = user ? `cart_${user}` : "cart";
    const cart = JSON.parse(localStorage.getItem(key)) || [];

    if (cart.length === 0) {
        showToast("Your cart is empty! Add items before checkout.", "error");
        return;
    }

    // Save the cart to a temporary key for the payment page
    localStorage.setItem("checkout_cart", JSON.stringify(cart));

    alert("Proceeding to checkout...");
    window.location.href = "/payment/";
    });


  document.getElementById("empty-cart-btn").addEventListener("click", async () => {
  const confirmed = await customConfirm("Are you sure you want to empty your cart?");
  if (confirmed) {
    localStorage.removeItem(key);
    cart = [];
    renderCart();
    showToast("Your cart has been emptied!", "success");
  } else {
    showToast("Cancelled", "warning");
  }
});


  renderCart();
});
</script>

{{ end }}
