    {{ define "main" }}
    <section class="store-layout">
      <!-- üéö Sidebar Filter -->
      <!-- üéö Sidebar Filter -->
      <!-- üéö Sidebar Filter -->
      <aside class="filter-sidebar">
        <!-- üéö GENRES FILTER -->
        <div class="filter-group">
          <button class="filter-toggle" data-target="genres">
            Genres <span class="arrow">‚ñº</span>
          </button>

          <div class="filter-options" id="genres">
            <div class="filter-scroll">
              {{ $genres := slice }}
              {{ range site.Data.products }}
                {{ range .genres }}
                  {{ if not (in $genres .) }}
                    {{ $genres = $genres | append . }}
                  {{ end }}
                {{ end }}
              {{ end }}
              {{ range sort $genres }}
              <div class="filter-item" data-genre="{{ . | lower }}">
                <span class="checkbox"></span>
                <span class="label">{{ . }}</span>
              </div>
              {{ end }}
            </div>
            <button class="clear-filters-link clear-genres">Clear genres</button>
          </div>
        </div>

        <!-- üéÆ MODES FILTER -->
        <div class="filter-group">
          <button class="filter-toggle" data-target="modes">
            Modes <span class="arrow">‚ñº</span>
          </button>

          <div class="filter-options" id="modes">
            <div class="filter-scroll">
              <div class="filter-item" data-mode="multiplayer">
                <span class="checkbox"></span>
                <span class="label">Multiplayer</span>
              </div>
              <div class="filter-item" data-mode="singleplayer">
                <span class="checkbox"></span>
                <span class="label">Singleplayer</span>
              </div>
              <div class="filter-item" data-mode="co-op">
                <span class="checkbox"></span>
                <span class="label">Co-op</span>
              </div>
            </div>
            <button class="clear-filters-link clear-modes">Clear modes</button>
          </div>
        </div>
        
        <div class="filter-group">
          <button class="filter-toggle" data-target="compat">
            Platform <span class="arrow">‚ñº</span>
          </button>

          <div class="filter-options" id="compat">
            <div class="filter-scroll">
              <div class="filter-item" data-compat="ps5">
                <span class="checkbox"></span>
                <span class="label">PS5</span>
              </div>

              <div class="filter-item" data-compat="ps4">
                <span class="checkbox"></span>
                <span class="label">PS4</span>
              </div>
            </div>

            <button class="clear-filters-link clear-compat">
              Clear compatibility
            </button>
          </div>
        </div>
      </aside>


      <!-- üéÆ Main Product Section -->
      <div class="products-section">
        <h1 class="page-title">üéÆ Our Games</h1>

        <!-- üîç Search Bar -->
        <div class="search-container">
          <div class="search-bar">
            <span class="search-icon">üîé</span>
            <input id="search-bar" placeholder="Search for games..." aria-label="Search" />
          </div>
        </div>

        <!-- ‚öôÔ∏è Sort Controls -->
        <div class="sort-bar">
          <div class="sort-right">
            <label for="sort-select">Sort by:</label>
            <select id="sort-select">
              <option value="alphabet">A‚ÄìZ</option>
              <option value="alphabet-desc">Z‚ÄìA</option>
              <option value="price">Price: Low ‚Üí High</option>
              <option value="price-desc">Price: High ‚Üí Low</option>
              <option value="release">Release: Newest</option>
              <option value="release-old">Release: Oldest</option>
            </select>
          </div>
        </div>

        <div id="no-results" class="no-results">
          <span class="emoji">üîç</span>
          <strong>No matching games found</strong>
          <div style="margin-top: .4rem; font-size: .95rem; color:#c7dfff;">
            Try adjusting your filters or search.
          </div>
        </div>

        <!-- üì¶ Product Grid -->
        <div class="products-grid" id="products-grid">
          {{ range site.Data.products }}
          <article class="product-card"
            data-title="{{ lower .title }}"
            data-price="{{ .price }}"
            data-release="{{ .release_date }}"
            data-genres="{{- $clean := slice -}}
            {{- range .genres -}}
              {{- $clean = $clean | append (lower (trim . " ")) -}}
            {{- end -}}
            {{- delimit $clean "," -}}"

            data-compatibility="{{ .compatibility | lower }}"

            data-modes="{{- with .modes -}}
              {{- $m := trim . " " -}}
              {{- if gt (len $m) 0 -}}
                {{- if in $m "/" -}}
                  {{- $parts := split $m "/" -}}
                  {{- $clean := slice -}}
                  {{- range $parts -}}
                    {{- if gt (len (trim . " ")) 0 -}}
                      {{- $clean = $clean | append (lower (trim . " ")) -}}
                    {{- end -}}
                  {{- end -}}
                  {{- delimit $clean "," -}}
                {{- else -}}
                  {{- lower $m -}}
                {{- end -}}
              {{- else -}}
                none
              {{- end -}}
            {{- else -}}
              none
            {{- end -}}">

            
            <a href="/products/{{ .id }}/" class="product-link">
              <div class="thumb-wrap">
                <img src="{{ index .images 0 }}" alt="{{ .title }}" />
              </div>
              <h3>{{ .title }}</h3>
              <p class="price">${{ printf "%.2f" .price }}</p>
            </a>
          </article>
          {{ end }}
        </div>
      </div>
    </section>


    <style>
    /* ===== Base Layout ===== */
    .products-section {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
      color: #f5f5f5;
    }
    .page-title {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 1.5rem;
      color: #e5e5e5;
    }

    /* ===== Steam-Style Search Bar ===== */
    .search-container {
      display: flex;
      justify-content: center;
      margin-bottom: 1.2rem;
    }

    .search-bar {
      position: relative;
      width: 50%;
      max-width: 640px;
    }

    .search-bar input {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 2.6rem;
      border-radius: 10px;
      background: #1e293b;
      border: 1px solid #334155;
      color: #e2e8f0;
      font-size: 1rem;
      transition: all 0.25s ease;
      box-shadow: inset 0 0 8px rgba(255,255,255,0.03);
    }

    .search-bar input:focus {
      border-color: #4ea8ff;
      box-shadow: 0 0 8px rgba(78,168,255,0.4);
      outline: none;
    }

    .search-bar input::placeholder {
      color: #94a3b8;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 46%;
      transform: translateY(-50%);
      opacity: 0.7;
      font-size: 1.1rem;
      pointer-events: none;
    }


    /* ===== Sort Bar ===== */
    .sort-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin: 0.5rem 0 1.5rem;
      border-bottom: 1px solid #333;
      padding-bottom: 0.8rem;
    }
    .sort-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sort-right label {
      color: #ccc;
      font-weight: 500;
    }
    #sort-select {
      background: transparent;
      color: #7cc7ff;
      border: none;
      font-weight: 600;
      cursor: pointer;
      padding: 0.4rem 0.6rem;
      font-size: 0.95rem;
      border-radius: 6px;
      transition: color 0.2s;
    }
    #sort-select:hover {
      color: #7cc7ff;
    }

    /* ===== Product Grid ===== */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.2rem;
      justify-items: center;
      align-items: start;
      padding: 1rem;
    }

    /* ===== Product Card ===== */
    .product-card {
      width: 100%;
      max-width: 220px; /* slightly narrower for 4 clean cards per row */
      background: #2b2b2b;
      color: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      text-align: left;
      margin-bottom: 0.5rem;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 16px rgba(100, 181, 246, 0.3);
    }

    /* ===== Image Area ===== */
    .thumb-wrap {
      background: #111;
      border-radius: 8px 8px 0 0;
      width: 100%;
      height: 280px; /* fixed compact height for PS5 cases */
      overflow: hidden;
    }


    .product-card img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* fills the frame, no black bars */
      display: block;
      border-radius: 0; /* keep square edges like PS5 box */
      object-position: top center; /* keeps PS5 header visible */
    }

    /* ===== Game Info ===== */
    .product-card h3 {
      margin: 0.6rem 0.8rem 0.2rem;
      font-size: 0.95rem;
      color: #f5f5f5;
      line-height: 1.3;
      text-align: left;
      min-height: 2.6rem; /* keeps uniform height for titles */
    }

    .product-card .price {
      margin: 0.2rem 0.8rem 0.8rem;
      text-align: left;
      font-weight: 700;
      color: #64b5f6;
      font-size: 0.9rem;
    }

    /* ===== Product Grid ===== */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.2rem;
      justify-items: center;
      align-items: start;
      padding: 1rem;
    }

    /* ===== Responsive Grid ===== */
    @media (max-width: 1200px) {
      .products-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 900px) {
      .products-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .products-grid { grid-template-columns: 1fr; }
    }

    /* ===== Layout Fix: Sidebar scrolls naturally with product list ===== */
    .store-layout {
      display: flex;
      align-items: flex-start;
      gap: 2rem;
      width: 100%;
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 1rem;
      /* üß© Key: allow natural height so sticky can work */
      align-self: stretch;
    }

    /* Sidebar stays beside the list but scrolls *with* the page */
    .filter-sidebar {
      width: 200px;
      flex-shrink: 0;
      position: relative;   /* üëà not sticky or fixed */
      top: auto;
      margin-left: -140px;
      padding-top: 13.5rem;
      color: #e5e5e5;
      font-size: 0.9rem;
    }

    /* Let product list take remaining space */
    .products-section {
      flex: 1;
      min-width: 0;
    }

    /* ===== Accordion Header ===== */
    .filter-group {
      margin-bottom: 1rem;
    }

    .filter-toggle {
      background: none;
      color: #f3f3f3;
      font-weight: 600;
      font-size: 0.95rem;
      width: 100%;
      text-align: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 0.4rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      transition: color 0.2s ease;
    }
    .filter-toggle:hover {
      color: #7cc7ff;
    }

    .filter-toggle .arrow {
      font-size: 0.75rem;
      transition: transform 0.2s ease;
    }
    .filter-toggle.active .arrow {
      transform: rotate(180deg);
    }

    /* ===== Collapsible Options ===== */
    .filter-options {
      display: none;
      flex-direction: column;
      gap: 0.4rem;
      margin-top: 0.4rem;
      padding-left: 0.3rem;
    }
    .filter-options.active {
      display: flex;
    }

    /* ===== Checkbox Items ===== */
    .filter-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.25rem 0.2rem;
      border-radius: 6px;
      transition: background 0.15s;
    }
    .filter-item:hover {
      background: rgba(85, 155, 247, 0.12);
    }

    .checkbox {
      width: 15px;
      height: 15px;
      border-radius: 3px;
      border: 2px solid #666;
      display: inline-block;
      position: relative;
      transition: all 0.15s;
    }

    /* ‚úÖ Include */
    .filter-item.active .checkbox {
      background: #008efb;
      border-color: #0091ff;
    }
    .filter-item.active .checkbox::after {
      content: "‚úî";
      position: absolute;
      color: #fff;
      top: -1px;
      left: 3px;
      font-size: 0.7rem;
    }

    /* üö´ Exclude */
    .filter-item.exclude .checkbox {
      background: #a09e9e;
      border-color: #a09e9e;
    }
    .filter-item.exclude .checkbox::after {
      content: "‚úñ";
      position: absolute;
      color: #fff;
      top: -1px;
      left: 3px;
      font-size: 0.7rem;
    }

    /* ====== Clear Filters (Purple Bold Link) ====== */
    .clear-filters-link {
      background: none;
      border: none;
      color: #7cc7ff;
      text-decoration: underline;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: -0.7rem;
      text-align: left;
      padding-left: 0.2rem;
      transition: color 0.2s;
    }
    .clear-filters-link:hover {
      color: #7cc7ff;
    }

    /* ===== Responsive ===== */
    @media (max-width: 900px) {
      .store-layout {
        flex-direction: column;
      }
      .filter-sidebar {
        width: 100%;
        margin-left: 0;
        position: relative;
        top: 0;
      }
    }

    /* ===== Limit genre list height with scroll ===== */
    /* ===== Limit genre list height with scroll (Clear button stays fixed below) ===== */
    .filter-options {
      display: none;
      flex-direction: column;
      gap: 0.4rem;
      margin-top: 0.4rem;
      padding-left: 0.3rem;
    }

    .filter-options.active {
      display: flex;
    }

    /* Wrap only the genre items in a scrollable container */
    .filter-scroll {
      max-height: 250px;        /* shows around 10 items */
      overflow-y: auto;
      margin-bottom: 0.8rem;
      scrollbar-width: thin;
      scrollbar-color: #6cb9f5 #2b2b2b;
    }

    .filter-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .filter-scroll::-webkit-scrollbar-thumb {
      background: #7cc7ff;
      border-radius: 3px;
    }
    .filter-scroll::-webkit-scrollbar-track {
      background: #2b2b2b;
    }

  .pagination {
    text-align: center;
    margin: 2rem 0;
  }

  .pagination-list.fixed-size {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    list-style: none;
    gap: 0.5rem;
    padding: 0;
    margin: 0 auto;
    min-width: 420px; /* stays constant ‚Äî adjust to your layout */
  }

  .pagination-list li {
    width: 2rem;
    text-align: center;
    color: #ccc;
  }

  .pagination-list a,
  .pagination-list span {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 2rem;
    height: 2rem;
    border-radius: 6px;
    text-decoration: none;
    color: #e2e2e2;
    transition: all 0.2s;
  }

  .pagination-list a:hover {
    background: #3a3a3a;
    color: #7cc7ff;
  }

  .pagination-list .active {
    background: #4788ba;
    color: #fff;
    font-weight: 700;
  }

  .pagination-list .disabled {
    visibility: hidden;
    pointer-events: none;
  }

  .pagination-list .dots {
    pointer-events: none;
    opacity: 0.6;
    font-weight: bold;
  }

  @media (max-width: 500px) {
    .pagination-list.fixed-size {
      min-width: 320px;
    }
  }


  .no-results {
  display: none;
  text-align: center;
  margin: 3rem auto;
  padding: 2rem;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 14px;
  width: min(420px, 90%);
  font-size: 1.2rem;
  color: #9cc9ff;
  box-shadow: 0 0 25px rgba(78, 168, 255, 0.1);
  animation: fadeIn 0.35s ease;
}

.no-results .emoji {
  display: block;
  font-size: 2.8rem;
  opacity: 0.9;
  margin-bottom: 0.8rem;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to   { opacity: 1; transform: translateY(0); }
}

    </style>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /* =====================================
       0) Declare state FIRST
    ====================================== */
    let includeGenres = new Set();
    let excludeGenres = new Set();
    let includeModes = new Set();
    let excludeModes = new Set();
    let includeCompat = new Set();
    // let excludeCompat = new Set();

    let currentPage = 1;
    const ITEMS_PER_PAGE = 16;

    /* =====================================
       1) DOM refs (must come BEFORE applyUI)
    ====================================== */
    const input = document.getElementById("search-bar");
    const sortSelect = document.getElementById("sort-select");
    const grid = document.getElementById("products-grid");
    const cards = Array.from(document.querySelectorAll(".product-card"));
    const noResults = document.getElementById("no-results");
    const toggles = document.querySelectorAll(".filter-toggle");
    const genreItems = document.querySelectorAll("[data-genre]");
    const modeItems = document.querySelectorAll("[data-mode]");
    const clearGenresBtn = document.querySelector(".clear-genres");
    const clearModesBtn = document.querySelector(".clear-modes");
    const compatItems = document.querySelectorAll("[data-compat]");
    const clearCompatBtn = document.querySelector(".clear-compat");


    /* =====================================
       2) Load URL ‚Üí STATE
    ====================================== */
    function loadFromURL() {
        const p = new URLSearchParams(location.search);

        if (p.has("q")) input.value = p.get("q");
        if (p.has("sort")) sortSelect.value = p.get("sort");

        if (p.has("genres")) p.get("genres").split(",").forEach(g => includeGenres.add(g));
        if (p.has("xgenres")) p.get("xgenres").split(",").forEach(g => excludeGenres.add(g));

        if (p.has("modes")) p.get("modes").split(",").forEach(m => includeModes.add(m));
        if (p.has("xmodes")) p.get("xmodes").split(",").forEach(m => excludeModes.add(m));

        if (p.has("compat")) p.get("compat").split(",").forEach(c => includeCompat.add(c));
        // if (p.has("xcompat")) p.get("xcompat").split(",").forEach(c => excludeCompat.add(c));

        if (p.has("page")) currentPage = parseInt(p.get("page")) || 1;
    }

    /* =====================================
       3) Apply state ‚Üí UI checkboxes
    ====================================== */
    function applyURLStateToUI() {
        genreItems.forEach(item => {
            const g = item.dataset.genre;
            if (includeGenres.has(g)) item.classList.add("active");
            if (excludeGenres.has(g)) item.classList.add("exclude");
        });

        modeItems.forEach(item => {
            const m = item.dataset.mode;
            if (includeModes.has(m)) item.classList.add("active");
            if (excludeModes.has(m)) item.classList.add("exclude");
        });

        compatItems.forEach(item => {
          const c = item.dataset.compat;
          if (includeCompat.has(c)) item.classList.add("active");
          // if (excludeCompat.has(c)) item.classList.add("exclude");
        });

    }

    /* =====================================
       4) Save ‚Üí URL
    ====================================== */
    function updateURL() {
        const p = new URLSearchParams();

        if (input.value.trim()) p.set("q", input.value.trim());
        p.set("sort", sortSelect.value);

        if (includeGenres.size) p.set("genres", [...includeGenres].join(","));
        if (excludeGenres.size) p.set("xgenres", [...excludeGenres].join(","));
        if (includeModes.size) p.set("modes", [...includeModes].join(","));
        if (excludeModes.size) p.set("xmodes", [...excludeModes].join(","));
        if (includeCompat.size) p.set("compat", [...includeCompat].join(","));
        // if (excludeCompat.size) p.set("xcompat", [...excludeCompat].join(","));


        p.set("page", currentPage);

        history.replaceState(null, "", "?" + p.toString());
    }

    /* =====================================
       5) Filtering + Sorting
    ====================================== */
    function doFilterAndSort() {
        const q = input.value.toLowerCase().trim();
        const sortBy = sortSelect.value;

        let visible = [];

        let sorted = [...cards].sort((a, b) => {
            const A = a.dataset, B = b.dataset;
            switch (sortBy) {
                case "alphabet": return A.title.localeCompare(B.title);
                case "alphabet-desc": return B.title.localeCompare(A.title);
                case "price": return A.price - B.price;
                case "price-desc": return B.price - A.price;
                case "release": return new Date(B.release) - new Date(A.release);
                case "release-old": return new Date(A.release) - new Date(B.release);
            }
            return 0;
        });

        grid.innerHTML = "";

        sorted.forEach(card => {
            const title = card.dataset.title;
            const genres = card.dataset.genres.split(",");
            const modes = card.dataset.modes.split(",");
            const compat = card.dataset.compatibility;  

            if (q && !title.includes(q)) return;
            if (includeGenres.size && ![...includeGenres].some(g => genres.includes(g))) return;
            if ([...excludeGenres].some(g => genres.includes(g))) return;
            if (includeModes.size && ![...includeModes].some(m => modes.includes(m))) return;
            if ([...excludeModes].some(m => modes.includes(m))) return;

            if (includeCompat.size && !includeCompat.has(compat)) return;
            // if (excludeCompat.has(compat)) return;

            visible.push(card);
        });

        const total = Math.ceil(visible.length / ITEMS_PER_PAGE);
        if (currentPage > total) currentPage = total || 1;

        visible
            .slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE)
            .forEach(c => grid.appendChild(c));

        noResults.style.display = visible.length ? "none" : "block";

        buildPagination(total);
    }

    /* =====================================
       6) Pagination
    ====================================== */
    const paginationContainer = document.createElement("div");
    paginationContainer.className = "pagination";
    grid.after(paginationContainer);

    function buildPagination(totalPages) {
        paginationContainer.innerHTML = "";
        if (totalPages <= 1) return;

        const ul = document.createElement("ul");
        ul.className = "pagination-list fixed-size";

        function add(label, page, active = false, disabled = false) {
            const li = document.createElement("li");
            if (disabled) li.innerHTML = `<span class="disabled">${label}</span>`;
            else if (active) li.innerHTML = `<span class="active">${label}</span>`;
            else li.innerHTML = `<a href="#" data-page="${page}">${label}</a>`;
            ul.appendChild(li);
        }

        add("‚Äπ", currentPage - 1, false, currentPage === 1);
        for (let i = 1; i <= totalPages; i++) add(i, i, i === currentPage);
        add("‚Ä∫", currentPage + 1, false, currentPage === totalPages);

        paginationContainer.appendChild(ul);

        ul.querySelectorAll("a").forEach(a => {
            a.addEventListener("click", e => {
                e.preventDefault();
                currentPage = parseInt(a.dataset.page);
                doFilterAndSort();
                updateURL();
                window.scrollTo({ top: 0, behavior: "smooth" });
            });
        });
    }

    /* =====================================
       7) Dropdown Fix ‚Äî your broken part
    ====================================== */
    toggles.forEach(btn => {
        btn.addEventListener("click", () => {
            const target = document.getElementById(btn.dataset.target);
            btn.classList.toggle("active");
            target.classList.toggle("active");
        });
    });

    /* =====================================
       8) Filter Click Logic
    ====================================== */
    genreItems.forEach(item => {
        item.addEventListener("click", () => {
            const g = item.dataset.genre;

            if (item.classList.contains("active")) {
                item.classList.remove("active");
                item.classList.add("exclude");
                includeGenres.delete(g);
                excludeGenres.add(g);
            }
            else if (item.classList.contains("exclude")) {
                item.classList.remove("exclude");
                excludeGenres.delete(g);
            }
            else {
                item.classList.add("active");
                includeGenres.add(g);
            }

            currentPage = 1;
            doFilterAndSort();
            updateURL();
        });
    });

    modeItems.forEach(item => {
        item.addEventListener("click", () => {
            const m = item.dataset.mode;

            if (item.classList.contains("active")) {
                item.classList.remove("active");
                item.classList.add("exclude");
                includeModes.delete(m);
                excludeModes.add(m);
            }
            else if (item.classList.contains("exclude")) {
                item.classList.remove("exclude");
                excludeModes.delete(m);
            }
            else {
                item.classList.add("active");
                includeModes.add(m);
            }

            currentPage = 1;
            doFilterAndSort();
            updateURL();
        });
    });

    compatItems.forEach(item => {
        item.addEventListener("click", () => {
            const c = item.dataset.compat;

            const alreadyActive = item.classList.contains("active");

            // Clear all first
            includeCompat.clear();
            compatItems.forEach(i => i.classList.remove("active"));

            // If clicking a non-active option ‚Üí activate it
            if (!alreadyActive) {
                item.classList.add("active");
                includeCompat.add(c);
            }

            currentPage = 1;
            doFilterAndSort();
            updateURL();
        });
    });



    /* =====================================
       9) Clear filters
    ====================================== */
    clearGenresBtn.addEventListener("click", () => {
        includeGenres.clear();
        excludeGenres.clear();
        genreItems.forEach(i => i.classList.remove("active", "exclude"));
        currentPage = 1;
        doFilterAndSort();
        updateURL();
    });

    clearModesBtn.addEventListener("click", () => {
        includeModes.clear();
        excludeModes.clear();
        modeItems.forEach(i => i.classList.remove("active", "exclude"));
        currentPage = 1;
        doFilterAndSort();
        updateURL();
    });

    clearCompatBtn.addEventListener("click", () => {
        includeCompat.clear();
        compatItems.forEach(i => i.classList.remove("active"));
        currentPage = 1;
        doFilterAndSort();
        updateURL();
    });
    /* =====================================
       10) Search + Sort
    ====================================== */
    input.addEventListener("input", () => {
        currentPage = 1;
        doFilterAndSort();
        updateURL();
    });

    sortSelect.addEventListener("change", () => {
        currentPage = 1;
        doFilterAndSort();
        updateURL();
    });

    /* =====================================
       FINAL INIT (correct order)
    ====================================== */
    loadFromURL();
    applyURLStateToUI();
    doFilterAndSort();
    updateURL();
});



</script>


    {{ end }}
