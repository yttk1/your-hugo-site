{{ define "main" }}
{{/* Extract the product ID from the URL */}}
{{ $id := replaceRE "^/products/([^/]+)/?$" "$1" .RelPermalink }}
{{ $products := site.Data.products }}
{{ $p := index (where $products "id" $id) 0 }}

{{ if not $p }}
  <div style="text-align:center; margin-top:4rem;">
    <h2>üò¢ Game not found</h2>
    <p>This product doesn‚Äôt exist in our database.</p>
    <a href="/products/" style="color:#38bdf8;">‚Üê Back to all games</a>
  </div>
{{ else }}
<div class="product-detail">
  <img src="{{ index $p.images 0 }}" alt="{{ $p.title }}">
  <div class="details">
    <h1>{{ $p.title }}</h1>
    <p class="price">${{ printf "%.2f" $p.price }}</p>
    <p class="desc">{{ $p.long }}</p>
    <button class="add-to-cart"
      data-id="{{ $p.id }}"
      data-title="{{ $p.title }}"
      data-price="{{ $p.price }}"
      data-img="{{ index $p.images 0 }}">
      Add to Cart
    </button>
  </div>
</div>
{{ end }}

<style>
.product-detail {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  gap: 2rem;
  padding: 2rem;
  background: #1e293b;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  color: #fff;
}
.product-detail img {
  width: 420px;
  border-radius: 10px;
  flex-shrink: 0;
}
.details { flex: 1; }
.details h1 { font-size: 2rem; margin-bottom: 0.5rem; }
.price { font-size: 1.4rem; color: #38bdf8; font-weight: bold; }
.desc { color: #e2e8f0; margin-top: 1rem; line-height: 1.6; }
.add-to-cart {
  background: #2563eb;
  color: white;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 1.2rem;
  font-size: 1rem;
  transition: background 0.2s;
}
.add-to-cart:hover { background: #1d4ed8; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.querySelector(".add-to-cart");
  if (!btn) return;

  btn.addEventListener("click", (e) => {
    const item = {
      id: e.target.dataset.id,
      title: e.target.dataset.title,
      price: parseFloat(e.target.dataset.price),
      img: e.target.dataset.img,
      qty: 1
    };

    const user = localStorage.getItem("user");
    const key = user ? `cart_${user}` : "cart";
    let cart = JSON.parse(localStorage.getItem(key)) || [];

    const existing = cart.find(p => p.id === item.id);
    if (existing) existing.qty += 1;
    else cart.push(item);

    localStorage.setItem(key, JSON.stringify(cart));
    alert(`${item.title} added to cart!`);
    updateCartCount();
  });

  function updateCartCount() {
    const user = localStorage.getItem("user");
    const key = user ? `cart_${user}` : "cart";
    const cart = JSON.parse(localStorage.getItem(key)) || [];
    const total = cart.reduce((sum, p) => sum + p.qty, 0);
    const countEl = document.getElementById("cart-count");
    if (countEl) countEl.textContent = total;
  }
});
</script>

{{ end }}
