{{ define "main" }}
{{ $id := replaceRE "^/products/([^/]+)/?$" "$1" .RelPermalink }}
{{ $products := site.Data.products }}
{{ $p := index (where $products "id" $id) 0 }}

{{ if not $p }}
<div style="text-align:center; margin-top:4rem;">
  <h2>üò¢ Game not found</h2>
  <p>This product doesn‚Äôt exist in our store database.</p>
  <a href="/products/" style="color:#38bdf8;">‚Üê Back to all games</a>
</div>
{{ else }}
<div class="game-container">
  <!-- üé• Trailer -->
  {{ if $p.trailer }}
  <div class="trailer">
    <iframe width="100%" height="450" src="{{ $p.trailer }}" frameborder="0" allowfullscreen></iframe>
  </div>
  {{ end }}

  <!-- üñºÔ∏è Image Gallery -->
  <div class="gallery">
    {{ range $p.images }}
    <img src="{{ . }}" alt="{{ $p.title }} screenshot">
    {{ end }}
  </div>

  <!-- üìù Game Details -->
  <div class="game-details">
    <h1>{{ $p.title }}</h1>
    <p class="price">${{ printf "%.2f" $p.price }}</p>
    <p class="meta">
      <strong>Developer:</strong> {{ $p.developer }}<br>
      <strong>Publisher:</strong> {{ $p.publisher }}<br>
      <strong>Release Date:</strong> {{ $p.release_date }}<br>
      <strong>Modes:</strong> {{ $p.modes }}<br>
      <strong>Genres:</strong> {{ delimit $p.genres ", " }}
    </p>

    <p class="desc">{{ $p.long }}</p>

    <!-- üõí Buttons -->
    <div class="buttons">
      <button class="buy-now"
        data-id="{{ $p.id }}"
        data-title="{{ $p.title }}"
        data-price="{{ $p.price }}"
        data-img="{{ index $p.images 0 }}">
        Buy Now
      </button>
      <button class="add-to-cart"
        data-id="{{ $p.id }}"
        data-title="{{ $p.title }}"
        data-price="{{ $p.price }}"
        data-img="{{ index $p.images 0 }}">
        Add to Cart
      </button>
      <button class="share-btn" onclick="shareGame('{{ $p.title }}', '{{ .Permalink }}')">Share</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const addToCartBtn = document.querySelector(".add-to-cart");
  const buyNowBtn = document.querySelector(".buy-now");

  // Add to Cart
  addToCartBtn.addEventListener("click", (e) => {
    const item = {
      id: e.target.dataset.id,
      title: e.target.dataset.title,
      price: parseFloat(e.target.dataset.price),
      img: e.target.dataset.img,
      qty: 1,
    };

    const user = localStorage.getItem("user");
    if (!user) {
      showToast("‚ö†Ô∏è Please log in first.", "warning");
      setTimeout(() => (window.location.href = "/login/"), 1200);
      return;
    }

    const key = `cart_${user}`;
    let cart = JSON.parse(localStorage.getItem(key)) || [];
    const existing = cart.find((p) => p.id === item.id);
    if (existing) existing.qty += 1;
    else cart.push(item);
    localStorage.setItem(key, JSON.stringify(cart));

    showToast(`üéÆ ${item.title} added to cart!`, "success");
  });

  // Buy Now
  buyNowBtn.addEventListener("click", (e) => {
    const item = {
      id: e.target.dataset.id,
      title: e.target.dataset.title,
      price: parseFloat(e.target.dataset.price),
      img: e.target.dataset.img,
      qty: 1,
    };

    const user = localStorage.getItem("user");
    if (!user) {
      showToast("‚ö†Ô∏è Please log in to buy games.", "warning");
      setTimeout(() => (window.location.href = "/login/"), 1200);
      return;
    }

    // Save for checkout
    const key = `checkout_${user}`;
    localStorage.setItem(key, JSON.stringify([item]));

    showToast("üí≥ Redirecting to payment...", "info");
    setTimeout(() => (window.location.href = "/payment/"), 1000);
  });
});
</script>



<style>
.game-container {
  background: #0f172a;
  color: #f8fafc;
  padding: 2rem;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.trailer iframe {
  border-radius: 10px;
  width: 100%;
  margin-bottom: 1.5rem;
}
.gallery {
  display: flex;
  gap: 1rem;
  overflow-x: auto;
  margin-bottom: 2rem;
}
.gallery img {
  height: 160px;
  border-radius: 8px;
  transition: transform 0.2s;
  cursor: pointer;
}
.gallery img:hover {
  transform: scale(1.05);
}
.game-details {
  margin-top: 1rem;
}
.price {
  color: #38bdf8;
  font-size: 1.5rem;
  font-weight: 700;
}
.meta {
  color: #94a3b8;
  line-height: 1.6;
  margin-bottom: 1rem;
}
.desc {
  color: #e2e8f0;
  margin: 1rem 0;
  font-size: 1.1rem;
  line-height: 1.6;
}
.buttons {
  display: flex;
  gap: 1rem;
  margin-top: 1rem;
}
.buttons button {
  padding: 0.8rem 1.4rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
  transition: background 0.2s, transform 0.1s;
}
.buy-now {
  background: linear-gradient(135deg, #9333ea, #6366f1);
  color: white;
}
.buy-now:hover { background: linear-gradient(135deg, #7e22ce, #4f46e5); transform: scale(1.03); }
.add-to-cart {
  background: linear-gradient(135deg, #2563eb, #3b82f6);
  color: white;
}
.add-to-cart:hover { background: linear-gradient(135deg, #1d4ed8, #2563eb); transform: scale(1.03); }
.share-btn {
  background: #334155;
  color: #f8fafc;
}
.share-btn:hover { background: #475569; transform: scale(1.03); }
</style>
{{ end }}
{{ end }}
